<script type="text/javascript" charset="utf-8">
  
  var allRunGrades = 
    [
    <% @run_grades.each do |grade| %>
      <%= "{ name:'#{grade[0]}', date:'#{grade[1]}', y:#{grade[2]} }," %>
    <% end %>
    ];
  var runGradesChart;
  
  jQuery(document).ready(function() {

    runGradesChart = new Highcharts.Chart({
      chart: { defaultSeriesType: "line", renderTo: "run_grades_chart" },
      title: { text: '<%= "running grades for #{@athlete.name}" %>' },
      credits: { enabled: false },
      legend: { enabled: false },
      tooltip: { formatter: function() { return this.point.name + ': ' + this.y; } },
      xAxis: { 
        title: { text: "race" },
        categories: [
        <% @run_grades.each do |grade| %>
          <%= "'#{grade[1]}', " %>
        <% end %>
        ]
      },
      yAxis: { title: { text: "grade" }, min: 0, max: 100 },
      series: [{
        data: [
          <% @run_grades.each do |grade| %>
          <%= "{ name: '#{grade[0]}', y: #{grade[2]} }," %>
          <% end %>
        ]
      }]
    });

    var recentRunSummariesChart = new Highcharts.Chart({
      chart: { defaultSeriesType: "column", renderTo: "recent_run_summaries" },   
      title: { text: '<%= "recent running races for #{@athlete.name}" %>' },    
      credits: { enabled: false },    
      xAxis: {     
      categories: ['everyone', 'gender', 'division', 'me'] },    
      yAxis: { title: { text: 'grade' }, min: 0, max: 100 },
      series: [
        <% @recent_run_summaries.each do |race_name, race_summary| %>
          {
            name: '<%= race_name %>',
            data: [<%= "#{race_summary['everyone']},#{race_summary['gender']},#{race_summary['div']},#{race_summary['me']}" %>]
          },
        <% end %>
      ]
    });
  
  });
  
  jQuery("button").button();
  function redrawChart() {
    if (runGradesChart.series.length) {
      runGradesChart.series[0].remove(false);
    }
    var newGrades = [];
    var newCategories = [];
    
    //iterate selected options
    jQuery("select#races option:selected").each(function () {
      var sel = $(this).text()
      //find the grade for the current selected option
      jQuery.each(allRunGrades, function(index, value) {
        if(value.name == sel) {
          //put it in the new series for the chart
          newGrades.push({name: value.name, y: value.y});
          newCategories.push(value.date);
        }
      });
    });
    alert(newCategories.toString());
    runGradesChart.xAxis[0].setCategories(newCategories);
    runGradesChart.addSeries({data: newGrades}, true);
  }
</script>


<p id="notice"><%= notice %></p>

<p>
  <b>name:</b>
  <%=h @athlete.name %>
</p>

<%= select_tag(:races, participation_options_in_race_order(@athlete), { :multiple => true, :id => 'races'}) %>
<button onclick="redrawChart();">redraw chart</button>


<div id="run_grades_chart" style="width:700px; height:300px;"></div>

<p/>

<div id="recent_run_summaries" style="width:700px; height:300px;"></div>

<p/>

<div class="tabs">
  <ul>
    <% ['friend','rival','other'].each do |type| %>
    <li><a href="#<%= type %>"><%= type.pluralize %></a></li>
    <% end %>
  </ul>

  <% ['friend','rival','other'].each do |type| %>
    <div id="<%= type %>">        
      <% @athlete.participations_by_race(type).each do |race,p_list| %>
      <b><%= "#{race.name} - #{race.race_on}" %></b>
      <table cellspacing="0" cellpadding="5">
        <tr><th>name</th><th>time</th><th>grade</th></tr>
        <% p_list.each do |p| %>
          <tr>
            <td><%= p.result.name %></td>
            <td><%= seconds_to_time(p.result.gun_time) %></td>
            <td><%= number_to_percentage(p.result.grade) %></td></tr>
        <% end %>
      </table>
      <% end %>
    </div>
  <% end %>

</div>
